<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AquaPredict Pro | RTRWH Prediction System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geometryutil/0.9.3/leaflet.geometryutil.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    /* (Your existing CSS — unchanged) */
    :root{--primary:#0066cc;--secondary:#00c4cc;--primary-light:#4d94ff;--dark:#0a0a14;--darker:#050510;--light:#f0f6ff}
    body{font-family:'Doto','Roboto',sans-serif;background:linear-gradient(135deg,var(--darker) 0%,var(--dark) 100%);color:var(--light);min-height:100vh}
    /* Keep styles from previous file; omitted for brevity in this snippet — use your full CSS from earlier */
    /* ... paste your full CSS here (or keep the same file you already have) ... */
    /* For clarity in this response I'll keep the CSS the same as your previous index.html (you already have it). */
  </style>
</head>
<body>
  <!-- Keep your full page HTML the same as before until the script section.
       For brevity, assume all header, map container, form HTML is identical to your existing file. -->
  <!-- paste the entire content from your previous index.html up to the <script> tag unchanged -->
  
  <!-- ================================================================= -->
  <!-- START OF JAVASCRIPT LOGIC TO CONNECT FRONTEND AND BACKEND -->
  <!-- ================================================================= -->
  <script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('prediction-form');
    const resultsSection = document.getElementById('results');
    const resultsContainer = document.getElementById('results-container');
    const submitButton = document.getElementById('submit-button');

    // --- Initialize Leaflet Map (Esri World Imagery satellite tiles) ---
    const map = L.map('map').setView([20.5937, 78.9629], 13); // Default to India
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics',
        maxZoom: 19,
        detectRetina: true
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { polygon: true, polyline: false, circle: false, rectangle: false, marker: false, circlemarker: false }
    });
    map.addControl(drawControl);

    // Geolocate user
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 17);
            L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
        });
    }

    // Handle polygon creation
    let polygonJSON = null;
    map.on(L.Draw.Event.CREATED, function(event) {
        const layer = event.layer;
        drawnItems.clearLayers(); // Keep only latest polygon
        drawnItems.addLayer(layer);

        // Convert to GeoJSON and compute geodesic area with Turf
        const geo = layer.toGeoJSON(); // GeoJSON uses [lng, lat]
        let area = 0;
        try {
            area = turf.area(geo); // in square meters (geodesic)
        } catch (e) {
            console.warn('Turf area failed, falling back to geometryutil', e);
            const latlngs = layer.getLatLngs()[0] || [];
            area = L.GeometryUtil.geodesicArea(latlngs);
        }

        polygonJSON = {
            area_m2: area,
            geojson: geo
        };

        // Auto-fill rooftop_area in form
        document.getElementById('rooftop_area').value = area.toFixed(2);

        const popupHtml = `<strong>Area:</strong> ${Number(area).toLocaleString(undefined, {maximumFractionDigits:2})} m²`;
        layer.bindPopup(popupHtml).openPopup();
    });

    // --- Form Submission ---
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';

        let latitude, longitude;
        try {
            const position = await new Promise((resolve, reject) => {
                if (!navigator.geolocation) reject('Geolocation not supported.');
                else navigator.geolocation.getCurrentPosition(resolve, reject);
            });
            latitude = position.coords.latitude;
            longitude = position.coords.longitude;
        } catch (error) {
            resultsContainer.innerHTML = `<div class="section-title"><h2>Error</h2><p>Could not get location: ${error.message || error}</p></div>`;
            resultsSection.classList.add('active');
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-calculator"></i> Calculate Prediction';
            return;
        }

        // Gather form data (add a few optional fields for recommendation engine)
        const formData = {
            rooftop_area: parseFloat(document.getElementById('rooftop_area').value),
            dwellers: parseInt(document.getElementById('dwellers').value, 10),
            roof_material: document.getElementById('roof_material').value,
            latitude: latitude,
            longitude: longitude,
            roof_polygon: polygonJSON ? polygonJSON.geojson : null,
            // optional tuning inputs (frontend can be extended to accept these)
            // infiltration_mm_hr, groundwater_depth_m, soil_type, slope, available_area_m2, runoff_quality, urban
            // we mostly rely on server-side estimates if these not provided
        };

        let data;
        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            data = await response.json();
        } catch (error) {
            resultsContainer.innerHTML = `<div class="section-title"><h2>Error</h2><p>Could not connect to backend: ${error.message || error}</p></div>`;
            resultsSection.classList.add('active');
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-calculator"></i> Calculate Prediction';
            return;
        }

        // Display results (including recommendations)
        try {
            const outputs = data.outputs || {};
            const prediction = outputs.ml_prediction || {};
            const recs = outputs.recommendations || []; // array of {structure, score, sizing_hint}
            const rainfall_status = outputs.rainfall_data_status || '';
            const rainfall_mm = outputs.annual_rainfall_mm_total || '';

            const formatNumber = (num) => {
                if (num === undefined || num === null || Number.isNaN(num)) return 'N/A';
                return Number(num).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
            };

            // build recommendations HTML
            let recHtml = '';
            if (Array.isArray(recs) && recs.length > 0) {
                recHtml += '<div style="margin-top:20px;"><h3 style="color:var(--primary-light)">Recommended Recharge Structures</h3>';
                recHtml += '<div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap">';
                recs.forEach(r => {
                    const prettyName = r.structure.replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase());
                    recHtml += `
                        <div style="background:linear-gradient(135deg, rgba(0,30,60,0.45), rgba(0,20,40,0.7));padding:18px;border-radius:12px;border:1px solid rgba(77,148,255,0.12);min-width:220px;max-width:320px;">
                          <div style="font-size:14px;color:var(--primary-light);margin-bottom:6px"><strong>${prettyName}</strong> — score: ${r.score}</div>
                          <div style="font-size:13px;color:var(--light);margin-bottom:8px">${r.sizing_hint}</div>
                        </div>
                    `;
                });
                recHtml += '</div></div>';
            } else {
                recHtml += '<div style="margin-top:20px;color:var(--light)">No recommendations available.</div>';
            }

            resultsContainer.innerHTML = `
                <div class="section-title">
                    <h2>Prediction Results</h2>
                    <p>Analysis of your property's rainwater harvesting potential</p>
                </div>
                <div class="results-grid" style="margin-top:20px;">
                    <div class="result-card">
                        <div class="result-label"><i class="fas fa-recycle"></i> Recharge Potential</div>
                        <div class="result-value">${formatNumber(prediction.recharge_potential)}</div>
                        <div class="result-unit">Liters/year</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label"><i class="fas fa-star"></i> Suitability Score</div>
                        <div class="result-value">${formatNumber(prediction.suitability_score * 100)}</div>
                        <div class="result-unit">out of 100</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label"><i class="fas fa-balance-scale"></i> Harvest-Demand Ratio</div>
                        <div class="result-value">${formatNumber(prediction.harvest_demand_ratio)}</div>
                        <div class="result-unit">Ratio</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label"> ₹ Cost Estimation</div>
                        <div class="result-value">Rs.${formatNumber(prediction.cost_estimation)}</div>
                        <div class="result-unit">INR</div>
                    </div>
                </div>

                <div class="interpretation" style="margin-top:24px">
                    <h3><i class="fas fa-lightbulb"></i> Interpretation</h3>
                    <p>Based on your inputs, the system has calculated the potential for rainwater harvesting. A higher suitability score means better suitability. The rainfall was calculated as <strong>${rainfall_mm} mm/year</strong> (${rainfall_status}).</p>
                </div>

                ${recHtml}
            `;

            resultsSection.classList.add('active');
            resultsSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            resultsContainer.innerHTML = `<div class="section-title"><h2>Error</h2><p>Could not display results: ${error.message || error}</p></div>`;
        }

        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-calculator"></i> Calculate Prediction';
    });
});
  </script>

  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.10.71/build/spline-viewer.js"></script>
</body>
</html>
